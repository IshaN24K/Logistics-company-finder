{% extends 'base.html' %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<h2>Add New Company</h2>
<form method="POST">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit">Save Company</button>
</form>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    $(document).ready(function() {
            // 1. Initialize Select2 for multi-select (only if present)
            if ($('.select2-multi').length) {
                $('.select2-multi').select2({ placeholder: "Select services..." });
            }

            const countrySelect = document.getElementById('country-select');
            const stateSelect = document.getElementById('state-select');

            // Ensure the selects exist on the page
            if (countrySelect && stateSelect) {
                // 2. Fetch Countries on load via server-side proxy (hides API key)
                fetch('/api/countries/')
                .then(res => {
                    if (!res.ok) throw new Error('Network response was not ok');
                    return res.json();
                })
                .then(data => {
                    countrySelect.innerHTML = '<option value="">Select Country</option>';
                    data.forEach(c => {
                        let opt = new Option(c.name, c.iso2); // text, value (ISO code like 'IN')
                        countrySelect.add(opt);
                    });
                })
                .catch(err => {
                    console.error('Error fetching countries:', err);
                    countrySelect.innerHTML = '<option value="">Unable to load countries</option>';
                });

                // 3. LISTEN for Country change to load States
                countrySelect.addEventListener('change', function() {
                    const countryCode = this.value; // e.g., 'IN'
                    stateSelect.innerHTML = '<option value="">Loading States...</option>';

                    if (countryCode) {
                        fetch(`/api/countries/${countryCode}/states/`)
                        .then(res => {
                            if (!res.ok) throw new Error('Network response was not ok');
                            return res.json();
                        })
                        .then(data => {
                            stateSelect.innerHTML = '<option value="">Select State</option>';
                            data.forEach(s => {
                                let opt = new Option(s.name, s.name);
                                stateSelect.add(opt);
                            });
                        })
                        .catch(err => {
                            console.error("Error fetching states:", err);
                            stateSelect.innerHTML = '<option value="">Unable to load states</option>';
                        });
                    } else {
                        stateSelect.innerHTML = '<option value="">Select a country first</option>';
                    }
                });
            }
    });
</script>
{% endblock %}